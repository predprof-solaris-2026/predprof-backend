name: Build and Deploy Backend

on:
  push:
    branches:
      - main

jobs:
  build_and_push:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build image
        run: |
          docker build -t sherstnew/predprof-backend:${{ github.sha }} .
          docker tag sherstnew/predprof-backend:${{ github.sha }} sherstnew/predprof-backend:latest

      - name: Push images
        run: |
          docker push sherstnew/predprof-backend:latest

  deploy:
    needs: build_and_push
    runs-on: self-hosted
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "Logging in to Docker Hub on remote host"
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            IMAGE="sherstnew/predprof-backend:latest"
            echo "Pulling image $IMAGE"
            docker pull "$IMAGE"

            echo "Stopping existing container if any"
            docker stop predprof-backend || true
            docker rm predprof-backend || true

            echo "Running new container"
            docker run -d \
              -p 8000:8000 \
              --name predprof-backend \
              -e MONGO_DSN="${{ secrets.MONGO_DSN }}" \
              -e ADMIN_TOKEN="${{ secrets.ADMIN_TOKEN }}" \
              -e ALGORITHM="${{ secrets.ALGORITHM }}" \
              -e SECRET_KEY="${{ secrets.SECRET_KEY }}" \
              -e SECURITY_KEY_USER="${{ secrets.SECURITY_KEY_USER }}" \
              -e ACCESS_TOKEN_EXPIRE_MINUTES="${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}" \
              -e ACCESS_TOKEN_EXPIRE_MINUTES_REDIS="${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES_REDIS }}" \
              -e ENVIRONMENT="${{ secrets.ENVIRONMENT }}" \
              -e GIGACHAT_AUTH_BASIC_KEY="${{ secrets.GIGACHAT_AUTH_BASIC_KEY }}" \
              -e GIGACHAT_SCOPE="${{ secrets.GIGACHAT_SCOPE }}" \
              -e GIGACHAT_MODEL="${{ secrets.GIGACHAT_MODEL }}" \
              -e GIGACHAT_CA_CERT="${{ secrets.GIGACHAT_CA_CERT }}" \
              --restart unless-stopped \
              "$IMAGE"
